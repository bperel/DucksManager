<template>
  <div>
    {{ $t('Cette page vous permet de trouver près de chez vous des bouquineries qui proposent fréquemment des magazines Disney.') }}
    <br><br>
    <div v-if="!bookstores.length">
      {{ $t('Chargement...') }}
    </div>
    <div
      v-else
      id="map"
    >
      <MglMap
        :access-token="accessToken"
        map-style="mapbox://styles/mapbox/light-v10"
        :center="mapCenter"
        :zoom="4"
      >
        <MglMarker
          v-for="bookstore in bookstores"
          v-once
          :key="bookstore.id"
          :coordinates="[bookstore.coordY, bookstore.coordX]"
        >
          <MglPopup>
            <div>
              <h2>{{ bookstore.name }}</h2>
              <div>
                <p>{{ bookstore.comment }}</p>
                <p>{{ bookstore.address }}</p>
                <p>
                  {{ $t('Signalé par') }}
                  <span v-if="bookstore.username">{{ bookstore.username }}</span>
                  <span v-else>{{ $t('un visiteur anonyme') }}</span>
                </p>
              </div>
            </div>
          </MglPopup>
        </MglMarker>
      </MglMap>
    </div>
    <br> <br>
    <h2>
      {{ $t('Proposer une bouquinerie') }}
    </h2>
    {{ $t('Vous connaissez une bouquinerie sympa ? Faites-en profiter d\'autres collectionneurs !') }}
    <br>
    {{ $t('Entrez ci-dessous les informations sur la bouquinerie que vous connaissez, puis entrez des exemples de prix de magazines.') }}
    <br>
    {{ $t('Nous comptons sur votre honnêteté concernant les prix si vous en mentionnez.') }}
    <br> <br>
    <form
      id="form_bouquinerie"
      method="post"
    >
      <b-form-input
        v-model="newBookstore.name"
        required
        maxlength="25"
        name="nom"
        type="text"
        :placeholder="$t('Nom de la bouquinerie')"
      />
      <b-form-input
        v-model="newBookstore.address"
        required
        name="full-address"
        type="text"
        :placeholder="$t('Adresse')"
      />
      <b-form-textarea
        v-model="newBookstore.comment"
        required
        cols="41"
        rows="5"
        maxlength="25"
        name="comments"
        type="text"
        :placeholder="$t('Commentaires (ambiance, exemples de prix,...)')"
      />
      <b-btn @click="suggestBookstore">
        {{ $t('Ajouter la bouquinerie') }}
      </b-btn>
      <b-alert variant="info">
        {{ $t('Un e-mail vient d\'être envoyé au webmaster.') }} {{ $t('Si votre bouquinerie est valide, elle sera ajoutée sur le site très prochainement.') }} {{ $t('Merci pour votre contribution !') }} ?>
      </b-alert>
    </form>
  </div>
</template>
<script>
import {MglMap, MglMarker, MglPopup} from "vue-mapbox";
import l10nMixin from "../mixins/l10nMixin";
import axios from "axios";

const newBookstore = {
  name: null,
  address: null,
  comment: null,
  coordX: null,
  coordY: null
}

export default {
  name: "Bookstores",

  components: {
    MglMap,
    MglMarker,
    MglPopup
  },

  mixins: [l10nMixin],

  data: () => ({
    accessToken: 'pk.eyJ1IjoiYnBlcmVsIiwiYSI6ImNqbmhubHVrdDBlZ20zcG8zYnQydmZwMnkifQ.suaRi8ln1w_DDDlTlQH0vQ',
    mapCenter: [1.73584, 46.754917],
    bookstores: [],
    newBookstore
  }),

  async mounted() {
    await this.fetchBookstores()
  },

  methods: {
    async fetchBookstores() {
      this.bookstores = (await axios.get('/bookstore/list')).data.map(bookstore => {
        try {
          ['name', 'address', 'comment'].forEach(field => {
            bookstore[field] = decodeURIComponent(escape(bookstore[field]))
          })
        }
        catch(_) {
          return null;
        }
        return bookstore
      }).filter(bookstore => !!bookstore)
    },
    async suggestBookstore() {
      await axios.put('/bookstore/suggest', this.newBookstore)
      this.newBookstore = newBookstore
    }
  }
}
</script>

<style lang="scss">
#map {
  height: 500px;

  .mapboxgl-marker {
    cursor: pointer;
  }

  .mapboxgl-popup-content {
    color: black;
  }
}
</style>
